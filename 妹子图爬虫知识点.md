# 妹子图爬虫知识点

[TOC]

## IPO框架

因为该[网站](https://www.mzitu.com)的图片有一个入口是每日更新，该[页面](https://www.mzitu.com/all/)的源代码包含了所有专辑的链接。是按照年份，然后月份的结构存放的。所以本爬虫实现按照年份和月份爬取某一月的所有图片。

Input:年份和月份。

Process:爬取mzitu图片

Output:分专辑编号的文件夹保存图片

## 本网站的Robots.txt

```
User-agent: *
Disallow: /index/
Disallow: /mm.html
Disallow: /in.html
Disallow: /feed
Disallow: /*/feed
Disallow: /trackback/
Disallow: /*/trackback
Disallow: /?s=*
Disallow: /search
Disallow: /?p=*
Disallow: /cgi-bin
```

## To run

Spyder已成功运行。

* 修改line 106和line 107的年份和月份，可以爬取其他月份的所有图片。可以通过查看[页面](https://www.mzitu.com/all/)源代码year查看年份起始范围。

* 修改line 106和line 107的年份和月份为input获取键盘输入形式，可以实现交互式获取。

## 知识点

* 本爬虫需要反爬虫技术，修改了headers字段。

* getHTMLText(url) 函数只修改了User-Agent字段。

* downloadImage(imgurl, root, imgTitle)函数中同时修改了User-Agent字段和Referer字段。其中对于Referer字段是变化的，所以定义了header(referer)函数。

* BeautifulSoup的find 函数，可以实现多级查找，即逐步缩小范围，在局部的标签中进一步查找。

* ```python
  def getCoverURL(page, year, month):
      html = getHTMLText(page)
      soup = BeautifulSoup(html, "html.parser")
      yearTag = soup.find('div', class_ = 'year', string = re.compile(r"^(%s)年$" %year)).find_next_sibling()
      monthTag = yearTag.find('em', string = re.compile(r"(%s)月$" %month)).parent.find_next_sibling('p', class_ = 'url')
      albumCovers = []
      for tag in monthTag.find_all('a', target = '_blank'):
          print(tag['href'])
          albumCovers.append(tag['href'])
      return albumCovers
  ```

* BeautifulSoup的find 函数查找属性class的值时，因为class关键词保留，所以可以用class_，

* ```python
  def getImgurl(url):
      html = getHTMLText(url)
      soup = BeautifulSoup(html, "html.parser")
      imgurl = ''
      imgurl = soup.find('div', class_ = 'main-image').img['src']
      return imgurl
  ```

* 详细的[BeautifulSoup文档说明](https://www.crummy.com/software/BeautifulSoup/bs4/doc/)，本次阅读获益匪浅，可以常查常看。

* 正则表达式中使用变量的方法：

* ```python
  soup.find('div', class_ = 'year', string = re.compile(r"^(%s)年$" %year))
  ```


* 爬取图片的保存实现了按照专辑名称分子文件夹进行保存。

## 致谢

* [wistbean github](https://github.com/wistbean/learn_python3_spider/blob/master/meizitu.py)

